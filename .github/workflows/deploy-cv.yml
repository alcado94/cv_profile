name: Generate and Deploy CV to GitHub Pages

on:
  # Trigger on push to main branch
  push:
    branches: [ main, master ]
  
# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-cv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        
    # - name: Validate CV schema
    #   run: |
    #     python3 src/builder.py CV/MAC.json --validate
        
    # - name: List available templates
    #   run: |
    #     python3 src/builder.py CV/MAC.json --list-templates
        
    - name: Generate All CV Variants
      run: |
        python3 src/generate_all.py \
          --config config/templates.json \
          --data-dir CV \
          --template-dir templates \
          --output-dir public
        
    - name: Add favicon and meta tags
      run: |
        # Add favicon to all HTML files
        sed -i 's|<head>|<head>\n    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3EðŸ‘¨â€ðŸ’»%3C/text%3E%3C/svg%3E">|g' public/*.html
        
        # Add meta description
        sed -i 's|<meta name="viewport"|<meta name="description" content="CV de Alejandro Campos DomÃ­nguez - Data Scientist/ML Engineer con mÃ¡s de 7 aÃ±os de experiencia en ML, IA Generativa, Big Data y DevOps">\n    <meta name="viewport"|g' public/*.html
        
        # Add Open Graph meta tags
        sed -i 's|<meta name="viewport"|<meta property="og:title" content="CV - Alejandro Campos DomÃ­nguez">\n    <meta property="og:description" content="Data Scientist/ML Engineer con experiencia en ML, IA Generativa, Big Data y DevOps">\n    <meta property="og:type" content="profile">\n    <meta name="viewport"|g' public/*.html
        
    - name: Upload artifacts
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: generate-cv
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
  # Optional: Create a release with the generated CV files
  create-release:
    runs-on: ubuntu-latest
    needs: generate-cv
    if: github.event_name == 'push' && contains(github.event.head_commit.message, '[release]')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: github-pages
          path: ./cv-files
          
      - name: Extract and prepare release files
        run: |
          cd cv-files
          tar -xf artifact.tar
          mkdir -p ../release-files
          python3 - <<'PY'
          import json
          from pathlib import Path

          config_path = Path("../config/templates.json")
          config = json.loads(config_path.read_text(encoding="utf-8"))
          templates = config.get("templates", [])

          release_dir = Path("../release-files")
          release_dir.mkdir(parents=True, exist_ok=True)

          release_files = []
          for entry in templates:
              release = entry.get("release", {})
              if not release.get("include"):
                  continue

              source_name = entry.get("output")
              target_name = release.get("filename") or source_name
              if not source_name:
                  continue

              source_path = Path(".") / source_name
              target_path = release_dir / target_name
              if source_path.exists():
                  target_path.write_bytes(source_path.read_bytes())
                  release_files.append(target_name)

          body_lines = [
              "Nueva version del CV generada automaticamente",
              "",
              "Archivos incluidos:",
          ]
          body_lines.extend([f"- `{name}`" for name in release_files])
          (release_dir / "body.txt").write_text("\n".join(body_lines), encoding="utf-8")
          PY
          {
            echo "RELEASE_BODY<<EOF"
            cat ../release-files/body.txt
            echo "EOF"
          } >> $GITHUB_ENV
          
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: cv-${{ github.sha }}
          release_name: CV Release $(date '+%Y-%m-%d')
          body: ${{ env.RELEASE_BODY }}
          draft: false
          prerelease: false 
